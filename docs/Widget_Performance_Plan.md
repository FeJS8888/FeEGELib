# Widget 渲染性能改进方案（仅方案，未实施）

> 目标：梳理当前 Widget 体系的绘制链路，找出影响性能的热点，并给出可操作的优化方向。本文仅提供方案，未改动任何代码。

## 现状梳理
- `Panel::draw` 每帧都会清空图层、重绘圆角背景，并在循环中为全部子控件调用 `draw`，即便状态未变化仍整板重绘（`src/Widget.cpp`）。
- `Panel::draw` 每次绘制都会调用 `layout->apply`，布局无变更也重复计算。
- `Button`、`InputBox`、`Slider` 等控件有局部缓存（`needRedraw` 等），但在 `Panel` 上层的全量重绘使缓存收益打折。
- `InputBox::draw` 在聚焦时每帧多次 `measuretext` 计算光标/IME 宽度，即便内容未变化也有重复测量。
- 各控件的绘制区域总是整块 `putimage`，未利用脏矩形或可视区域裁剪。

## 优化方向
1. **脏矩形 / 重绘标记**  
   - 为 `Widget`/`Panel` 增加脏标记，只有自身或子控件状态变动时才重绘缓存图层；聚合子控件的脏区域，在最终 `putimage` 时只复制变动区域。  
   - 动画控件（Ripple/进度条等）在动画结束后清理脏标记，避免持续刷新。

2. **分层缓存与静态背景复用**  
   - 将静态背景（圆角面板底色、按钮底板）与动态前景（文本、动画）分层缓存：静态层仅在尺寸/颜色/圆角/缩放变化时重绘，动态层按需叠加。  
   - 对 `Panel` 支持“冻结”模式：内容静态时直接复用上次合成结果，不再遍历子控件。
   - 依据现有 `Button` 的懒标记思路，为 `Panel` 增加懒标记并复用已遮罩好的缓存层，复用时优先使用 `putimage_withalpha`（开销低于 `putimage_alphafilter`），仅在尺寸/圆角/缩放变化需要重新生成遮罩时再走 `alphafilter`。

3. **布局与尺寸缓存**  
   - 为 `Layout` 维护 `layoutDirty` 标记，在子控件增删、尺寸/缩放变化时才重算 offsets；`Panel::draw` 不再每帧调用 `apply`。  
   - 当 `Panel` 缩放时批量更新子控件 offset 后缓存结果，避免每帧重复 `setPosition`/`setScale`。

4. **文本测量与字体缓存**  
   - `InputBox` / `Text`：将 `measuretext` 结果按 `(content, cursorPos, scale, font)` 组合缓存，仅在对应字段变化时重新测量；IME 组合字符串也走相同缓存。  
   - 预创建字体对象（LOGFONT）并按 `scale` 分级缓存，减少 `ege_setfont` 调用。

5. **可见性与裁剪**  
   - 为控件增加可见性/裁剪检查，超出父面板或窗口区域时跳过绘制或仅绘制交集区域，降低 `putimage` 面积。  
   - 对隐藏或折叠（如 Sidebar 收起）状态，直接跳过子树绘制与事件命中。

6. **动画驱动与刷新节流**  
   - 将 Ripple / 过渡动画驱动放入统一的 ticker，只有动画存活时触发脏标记；无动画时不进入重绘分支。  
   - 鼠标悬停/光标闪烁使用计时器节流，降低高频 `draw` 调用。

7. **资源与内存管理**  
   - 为 `newimage` 创建的缓存层加入池化或生命周期复用，避免频繁分配释放（特别是 `setScale` 后的重建）。  
   - 对大尺寸面板支持惰性分块缓存（tiles），局部脏区域只更新对应 tile。

## 验证与落地建议
- 增加简单的绘制耗时采样（宏封装 `std::chrono` 或平台计时）输出到调试日志，先定位重绘热点，再按优先级落地。  
- 先从「脏标记 + 静态背景缓存」与「布局缓存」入手，对现有接口侵入小、收益高；其余方案可分阶段逐步实现。  
- 优先在典型场景（含多 Panel/大量文本输入/频繁动画）做 A/B 对比，验证 FPS 与 CPU 占用变化。

以上方案可单独或组合实施，可按优先级逐步引入，确保每次改动可测、可回退。
