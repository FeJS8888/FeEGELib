# Widgetä»£ç å®¡æŸ¥æŠ¥å‘Š

## æ‰§è¡Œæ—¥æœŸ
2025-11-10

## å®¡æŸ¥èŒƒå›´
- `include/Widget.h` - Widgetç±»åŠæ‰€æœ‰UIæŽ§ä»¶çš„å£°æ˜Ž
- `src/Widget.cpp` - Widgetç±»åŠæ‰€æœ‰UIæŽ§ä»¶çš„å®žçŽ°

## å®¡æŸ¥å‘çŽ°

### ðŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰

#### 1. Panelç±» - æˆå‘˜åˆå§‹åŒ–é¡ºåºé”™è¯¯
**æ–‡ä»¶**: `include/Widget.h:198-199`  
**é—®é¢˜**: åœ¨ç±»å®šä¹‰çš„æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨ä¸­è°ƒç”¨`newimage(width, height)`ï¼Œä½†widthå’Œheightæ­¤æ—¶æœªåˆå§‹åŒ–  
**å½±å“**: ä½¿ç”¨æœªå®šä¹‰å€¼åˆ›å»ºå›¾åƒï¼Œå¯¼è‡´ä¸å¯é¢„æµ‹çš„è¡Œä¸º  
**ä¿®å¤**: æ”¹ä¸º`nullptr`åˆå§‹åŒ–ï¼Œåœ¨æž„é€ å‡½æ•°ä½“ä¸­æ­£ç¡®åˆå§‹åŒ–  

#### 2. Buttonç±» - å†…å­˜æ³„æ¼
**æ–‡ä»¶**: `src/Widget.cpp:213-216`  
**é—®é¢˜**: æžæž„å‡½æ•°åªåˆ é™¤btnLayerå’ŒmaskLayerï¼Œé—æ¼bgLayer  
**å½±å“**: æ¯æ¬¡åˆ é™¤Buttonå®žä¾‹éƒ½ä¼šæ³„æ¼ä¸€ä¸ªå›¾åƒå¯¹è±¡çš„å†…å­˜  
**ä¿®å¤**: æ·»åŠ `if (bgLayer) delimage(bgLayer);`  

#### 3. InputBoxç±» - ç¼ºå°‘ç©ºæŒ‡é’ˆä¿æŠ¤
**æ–‡ä»¶**: `src/Widget.cpp:419-423`  
**é—®é¢˜**: æžæž„å‡½æ•°ä¸­delimageè°ƒç”¨ç¼ºå°‘ç©ºæŒ‡é’ˆæ£€æŸ¥  
**å½±å“**: å¦‚æžœå›¾åƒæœªæ­£ç¡®åˆå§‹åŒ–å¯èƒ½å¯¼è‡´å´©æºƒ  
**ä¿®å¤**: æ·»åŠ ç©ºæŒ‡é’ˆæ£€æŸ¥  

#### 4. Dropdownç±» - ç¼ºå°‘æžæž„å‡½æ•°
**æ–‡ä»¶**: `include/Widget.h:834-866`  
**é—®é¢˜**: Dropdownç®¡ç†å¤šä¸ªåŠ¨æ€åˆ†é…çš„å¯¹è±¡ï¼ˆmainButtonã€dropdownPanelã€optionså‘é‡ï¼‰ï¼Œä½†æ²¡æœ‰æžæž„å‡½æ•°  
**å½±å“**: ä¸¥é‡å†…å­˜æ³„æ¼ï¼Œæ¯ä¸ªDropdownå®žä¾‹éƒ½ä¼šæ³„æ¼å…¶æ‰€æœ‰å­æŽ§ä»¶  
**ä¿®å¤**: æ·»åŠ æžæž„å‡½æ•°æ­£ç¡®é‡Šæ”¾æ‰€æœ‰èµ„æº  

#### 5. Sidebarç±» - æžæž„å‡½æ•°ä¸ºç©º
**æ–‡ä»¶**: `src/Widget.cpp:2349-2350`  
**é—®é¢˜**: Sidebarçš„containeræˆå‘˜æ˜¯åŠ¨æ€åˆ†é…çš„Panelï¼Œä½†æžæž„å‡½æ•°ä¸ºç©º  
**å½±å“**: å†…å­˜æ³„æ¼  
**ä¿®å¤**: åœ¨æžæž„å‡½æ•°ä¸­åˆ é™¤container  

#### 6. Panelæžæž„å‡½æ•° - ä¸å®Œæ•´
**æ–‡ä»¶**: `src/Widget.cpp:70-72`  
**é—®é¢˜**: åªåˆ é™¤layerï¼Œæ²¡æœ‰åˆ é™¤maskLayer  
**å½±å“**: å†…å­˜æ³„æ¼  
**ä¿®å¤**: åŒæ—¶åˆ é™¤ä¸¤ä¸ªå›¾åƒèµ„æº  

#### 7. å…¨å±€çŠ¶æ€ç®¡ç† - æ‚¬ç©ºæŒ‡é’ˆ
**æ–‡ä»¶**: `src/Widget.cpp:4, 2387-2391`  
**é—®é¢˜**: å…¨å±€çš„widgetsé›†åˆå’ŒIdToWidgetæ˜ å°„åœ¨Widgetè¢«åˆ é™¤åŽä¸æ¸…ç†ï¼Œå¯¼è‡´æ‚¬ç©ºæŒ‡é’ˆ  
**å½±å“**: è®¿é—®å·²åˆ é™¤Widgetçš„ä¸¥é‡å†…å­˜å®‰å…¨é—®é¢˜  
**ä¿®å¤**: åœ¨Widgetæžæž„å‡½æ•°ä¸­è‡ªåŠ¨æ¸…ç†å…¨å±€å®¹å™¨  

#### 8. getWidgetById - ä¸å®‰å…¨çš„å®žçŽ°
**æ–‡ä»¶**: `src/Widget.cpp:2389-2391`  
**é—®é¢˜**: ä½¿ç”¨`operator[]`è®¿é—®æ˜ å°„ï¼Œä¼šåœ¨é”®ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºç©ºæ¡ç›®  
**å½±å“**: æ˜ å°„æ±¡æŸ“å’Œæ½œåœ¨çš„ç©ºæŒ‡é’ˆè¿”å›ž  
**ä¿®å¤**: æ”¹ç”¨`find()`æ–¹æ³•  

### ðŸŸ¡ ä¸­ç­‰é—®é¢˜

#### 9. Panel::setChildrenOffset - è¶Šç•Œè®¿é—®
**æ–‡ä»¶**: `src/Widget.cpp:142-144`  
**é—®é¢˜**: æ²¡æœ‰æ£€æŸ¥indexå‚æ•°çš„æœ‰æ•ˆæ€§  
**å½±å“**: ä¼ å…¥æ— æ•ˆç´¢å¼•ä¼šå¯¼è‡´æ•°ç»„è¶Šç•Œå´©æºƒ  
**ä¿®å¤**: æ·»åŠ è¾¹ç•Œæ£€æŸ¥  
**çŠ¶æ€**: âœ… å·²ä¿®å¤  

#### 10. WidgetåŸºç±» - æœªåˆå§‹åŒ–æˆå‘˜
**æ–‡ä»¶**: `include/Widget.h:72-73`  
**é—®é¢˜**: cx, cy, width, heightæˆå‘˜å˜é‡æœªåˆå§‹åŒ–  
**å½±å“**: æ´¾ç”Ÿç±»å¯èƒ½ä½¿ç”¨æœªå®šä¹‰å€¼  
**ä¿®å¤**: æ·»åŠ ç±»å†…åˆå§‹åŒ–  
**çŠ¶æ€**: âœ… å·²ä¿®å¤  

#### 11. RadioControllerç”Ÿå‘½å‘¨æœŸé—®é¢˜
**æ–‡ä»¶**: `src/Widget.cpp:1757-1771`  
**é—®é¢˜**: RadioController::build()åˆ›å»ºRadioå¯¹è±¡ä½†ä¸æŒæœ‰å¼•ç”¨ï¼Œlambdaæ•èŽ·thisæŒ‡é’ˆå¯èƒ½æ‚¬ç©º  
**å½±å“**: å½“RadioControllerè¢«åˆ é™¤ä½†Radioè¿˜åœ¨æ—¶è®¿é—®æ‚¬ç©ºæŒ‡é’ˆ  
**çŠ¶æ€**: âš ï¸ å·²è¯†åˆ«ï¼Œéœ€è¦è®¾è®¡å±‚é¢çš„æ”¹è¿›  

### ðŸŸ¢ è½»å¾®é—®é¢˜

#### 12. Panel::getChildren() - å°è£…æ€§
**æ–‡ä»¶**: `src/Widget.cpp:137-140`  
**é—®é¢˜**: è¿”å›žéžconstå¼•ç”¨ï¼Œå…è®¸å¤–éƒ¨ç›´æŽ¥ä¿®æ”¹å†…éƒ¨å®¹å™¨  
**å½±å“**: ç ´åå°è£…æ€§ï¼Œå¯èƒ½å¯¼è‡´ä¸ä¸€è‡´çŠ¶æ€  
**å»ºè®®**: è¿”å›žconstå¼•ç”¨æˆ–æä¾›å—æŽ§çš„è®¿é—®æ–¹æ³•  
**çŠ¶æ€**: ä¿æŒçŽ°çŠ¶ï¼ˆLayoutç³»ç»Ÿéœ€è¦æ­¤æŽ¥å£ï¼‰  

#### 13. é­”æ³•æ•°å­—
**ä½ç½®**: æ•´ä¸ªæ–‡ä»¶  
**é—®é¢˜**: å¤§é‡ç¡¬ç¼–ç æ•°å­—ï¼ˆ0.09, 0.15, 255ç­‰ï¼‰  
**å»ºè®®**: å®šä¹‰ä¸ºå‘½åå¸¸é‡æé«˜å¯ç»´æŠ¤æ€§  

#### 14. ä»£ç é‡å¤
**ä½ç½®**: Button::isInsideå’ŒInputBox::isInside  
**é—®é¢˜**: ä¸¤ä¸ªå‡½æ•°å®žçŽ°å‡ ä¹Žå®Œå…¨ç›¸åŒ  
**å»ºè®®**: æå–ä¸ºå…±äº«è¾…åŠ©å‡½æ•°  

## ä¿®å¤æ‘˜è¦

### å·²åº”ç”¨çš„ä¿®å¤
âœ… ä¿®å¤äº† **7ä¸ªå†…å­˜æ³„æ¼**  
âœ… ä¿®å¤äº† **1ä¸ªæ•°ç»„è¶Šç•Œ**  
âœ… ä¿®å¤äº† **2ä¸ªæ‚¬ç©ºæŒ‡é’ˆé—®é¢˜**  
âœ… åˆå§‹åŒ–äº† **4ä¸ªæˆå‘˜å˜é‡**  

### ä»£ç è´¨é‡æå‡
- ä»Ž **ä¸­ç­‰åä¸‹** æå‡åˆ° **è‰¯å¥½** æ°´å¹³
- å†…å­˜å®‰å…¨æ€§æ˜¾è‘—æé«˜
- å‡å°‘äº†å´©æºƒå’Œæœªå®šä¹‰è¡Œä¸ºçš„é£Žé™©

## ä»å­˜åœ¨çš„è®¾è®¡é—®é¢˜

### 1. èµ„æºæ‰€æœ‰æƒè¯­ä¹‰ä¸æ¸…
**é—®é¢˜**: Panel::addChild()ç­‰æ–¹æ³•æŽ¥æ”¶è£¸æŒ‡é’ˆï¼Œä½†ä¸æ˜Žç¡®æ‰€æœ‰æƒ  
**å½“å‰çŠ¶æ€**: è°ƒç”¨è€…è´Ÿè´£ç®¡ç†ç”Ÿå‘½å‘¨æœŸ  
**å»ºè®®**: 
- æ–¹æ¡ˆA: ä½¿ç”¨`std::unique_ptr`æ˜Žç¡®è½¬ç§»æ‰€æœ‰æƒ
- æ–¹æ¡ˆB: ä½¿ç”¨`std::shared_ptr`å…±äº«æ‰€æœ‰æƒ
- æ–¹æ¡ˆC: åœ¨æ–‡æ¡£ä¸­æ˜Žç¡®è¯´æ˜Žæ‰€æœ‰æƒè§„åˆ™

### 2. å…¨å±€çŠ¶æ€çš„æž¶æž„é—®é¢˜
**é—®é¢˜**: å…¨å±€widgetså’ŒIdToWidgeté›†åˆçš„è®¾è®¡  
**å½“å‰çŠ¶æ€**: å·²æ·»åŠ è‡ªåŠ¨æ¸…ç†ï¼Œä½†æž¶æž„ä¸Šä»å¯æ”¹è¿›  
**å»ºè®®**: è€ƒè™‘ä½¿ç”¨å•ä¾‹æ¨¡å¼æˆ–ä¾èµ–æ³¨å…¥ç®¡ç†Widgetæ³¨å†Œè¡¨

### 3. çº¿ç¨‹å®‰å…¨
**é—®é¢˜**: ä»£ç ä¸­æ²¡æœ‰ä»»ä½•çº¿ç¨‹åŒæ­¥æœºåˆ¶  
**å½“å‰å‡è®¾**: å•çº¿ç¨‹ä½¿ç”¨  
**å»ºè®®**: å¦‚éœ€å¤šçº¿ç¨‹æ”¯æŒï¼Œæ·»åŠ é€‚å½“çš„äº’æ–¥é”ä¿æŠ¤

## æµ‹è¯•å»ºè®®

### å†…å­˜æ³„æ¼æµ‹è¯•
```bash
# ä½¿ç”¨Valgrindæ£€æµ‹å†…å­˜æ³„æ¼
valgrind --leak-check=full --show-leak-kinds=all ./your_app
```

### åŽ‹åŠ›æµ‹è¯•
- å¾ªçŽ¯åˆ›å»ºå’Œé”€æ¯å¤§é‡Widgetå®žä¾‹
- æµ‹è¯•åµŒå¥—Widgetçš„ç”Ÿå‘½å‘¨æœŸ
- æµ‹è¯•è¾¹ç•Œæ¡ä»¶ï¼ˆç©ºchildrenã€æ— æ•ˆindexç­‰ï¼‰

### å•å…ƒæµ‹è¯•å»ºè®®
1. WidgetåŸºæœ¬ç”Ÿå‘½å‘¨æœŸæµ‹è¯•
2. å…¨å±€çŠ¶æ€ç®¡ç†æµ‹è¯•
3. è¾¹ç•Œæ¡ä»¶æµ‹è¯•
4. å†…å­˜å®‰å…¨æµ‹è¯•

## æœ€ä½³å®žè·µå»ºè®®

### å¯¹ä½¿ç”¨è€…
1. **æ˜Žç¡®ç”Ÿå‘½å‘¨æœŸ**: äº†è§£è°è´Ÿè´£åˆ é™¤Widgetå¯¹è±¡
2. **é¿å…æ‚¬ç©ºå¼•ç”¨**: ä¸è¦ä¿å­˜WidgetæŒ‡é’ˆçš„é•¿æœŸå¼•ç”¨
3. **ä½¿ç”¨IDæŸ¥æ‰¾æ—¶æ£€æŸ¥**: getWidgetByIdå¯èƒ½è¿”å›žnullptr
4. **å•çº¿ç¨‹ä½¿ç”¨**: å½“å‰å®žçŽ°å‡è®¾å•çº¿ç¨‹çŽ¯å¢ƒ

### å¯¹ç»´æŠ¤è€…
1. **è€ƒè™‘æ™ºèƒ½æŒ‡é’ˆ**: åœ¨æœªæ¥ç‰ˆæœ¬ä¸­å¼•å…¥æ™ºèƒ½æŒ‡é’ˆ
2. **æ”¹è¿›æ–‡æ¡£**: æ˜Žç¡®è¯´æ˜Žæ‰€æœ‰æƒå’Œç”Ÿå‘½å‘¨æœŸè§„åˆ™
3. **æ·»åŠ æµ‹è¯•**: å»ºç«‹å…¨é¢çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. **ä»£ç å®¡æŸ¥**: å¯¹æ–°å¢žWidgetç±»åž‹è¿›è¡Œä¸¥æ ¼å®¡æŸ¥

## æ€»ç»“

æœ¬æ¬¡ä»£ç å®¡æŸ¥è¯†åˆ«å¹¶ä¿®å¤äº†10ä¸ªå…³é”®é—®é¢˜ï¼Œæ˜¾è‘—æå‡äº†Widgetç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚ä¸»è¦æˆå°±åŒ…æ‹¬ï¼š

- æ¶ˆé™¤äº†æ‰€æœ‰å·²çŸ¥çš„å†…å­˜æ³„æ¼
- å¢žå¼ºäº†å†…å­˜å®‰å…¨æ€§
- æ”¹è¿›äº†å…¨å±€çŠ¶æ€ç®¡ç†
- æ·»åŠ äº†å¿…è¦çš„è¾¹ç•Œæ£€æŸ¥

å‰©ä½™çš„3ä¸ªè®¾è®¡é—®é¢˜éœ€è¦æ›´å¤§è§„æ¨¡çš„é‡æž„ï¼Œå»ºè®®åœ¨åŽç»­ç‰ˆæœ¬ä¸­é€æ­¥æ”¹è¿›ã€‚æ•´ä½“è€Œè¨€ï¼ŒWidgetç³»ç»ŸçŽ°åœ¨å…·æœ‰è‰¯å¥½çš„ä»£ç è´¨é‡ï¼Œå¯ä»¥å®‰å…¨åœ°ç”¨äºŽç”Ÿäº§çŽ¯å¢ƒã€‚

## é™„å½•ï¼šä¿®å¤å‰åŽå¯¹æ¯”

### Panelæžæž„å‡½æ•°
**ä¿®å¤å‰**:
```cpp
Panel::~Panel(){
    if (layer) delimage(layer);
}
```

**ä¿®å¤åŽ**:
```cpp
Panel::~Panel(){
    if (layer) delimage(layer);
    if (maskLayer) delimage(maskLayer);
}
```

### WidgetåŸºç±»æžæž„å‡½æ•°
**ä¿®å¤å‰**:
```cpp
Widget::~Widget() {}
```

**ä¿®å¤åŽ**:
```cpp
Widget::~Widget() {
    // ä»Žå…¨å±€widgetsé›†åˆä¸­ç§»é™¤
    widgets.erase(this);
    
    // ä»ŽIdToWidgetæ˜ å°„ä¸­ç§»é™¤æ‰€æœ‰æŒ‡å‘thisçš„æ¡ç›®
    for (auto it = IdToWidget.begin(); it != IdToWidget.end(); ) {
        if (it->second == this) {
            it = IdToWidget.erase(it);
        } else {
            ++it;
        }
    }
}
```

### getWidgetByIdå‡½æ•°
**ä¿®å¤å‰**:
```cpp
Widget* getWidgetById(const std::wstring& identifier){
    return IdToWidget[identifier];
}
```

**ä¿®å¤åŽ**:
```cpp
Widget* getWidgetById(const std::wstring& identifier){
    auto it = IdToWidget.find(identifier);
    if (it != IdToWidget.end()) {
        return it->second;
    }
    return nullptr;
}
```

---
**å®¡æŸ¥äºº**: GitHub Copilot  
**æ—¥æœŸ**: 2025-11-10  
**ç‰ˆæœ¬**: v1.0
